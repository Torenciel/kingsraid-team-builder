<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KingsRaid Team Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .character-slot {
        background: #374151;
        border: 2px solid #6b7280;
        position: relative;
      }
      .character-slot.empty:hover {
        background: #4b5563;
      }
      .hero-card {
        background: #1f2937;
        position: relative;
        aspect-ratio: 1;
      }
      .hero-card.in-team {
        border: 4px solid #10B981;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
      }
      .hero-card:hover {
        scale: 1.05;
      }
.hero-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.4), transparent);
    color: white;
    padding: 4px 2px;
    font-size: 11px;
    text-align: center;
    height: 60px; /* Augmenter la hauteur */
    display: flex;
    align-items: flex-end; /* Pousse le texte vers le bas */
    justify-content: center;
}
      .hero-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .class-icon {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 20px;
        height: 20px;
        background-color: black;
        border: 0.5px solid black;
        border-radius: 100%;
      }
      .class-icon.missing {
        display: none;
      }
      .remove-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #EF4444;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid #1F2937;
        z-index: 10;
      }
      .character-slot:not(.empty):hover .remove-btn {
        display: flex;
      }
      .sub-slot {
        background: #374151;
        border: 2px solid #6b7280;
        border-radius: 4px;
        position: relative;
      }
      .sub-slot.empty:hover {
        background: #4b5563;
      }
      .sub-slot-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
      }
      .sub-remove-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #EF4444;
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        font-size: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid #1F2937;
        z-index: 10;
      }
      .sub-slot:not(.empty):hover .sub-remove-btn {
        display: flex;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: #111827;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }
      .ut-option, .uw-option, .artifact-option {
        width: 80px;
        height: 80px;
        cursor: pointer;
        border-radius: 4px;
        background: #374151;
        border: 2px solid #6b7280;
      }
      .ut-option:hover, .uw-option:hover, .artifact-option:hover {
        border-color: #10B981;
      }
      .ut-option.selected, .uw-option.selected, .artifact-option.selected {
        border-color: #3B82F6;
      }
      .stars-container {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 15px 0;
      }
      .star {
        font-size: 24px;
        cursor: pointer;
        color: #6B7280;
      }
      .star.filled {
        color: #FBBF24;
      }
      .star.hover-preview {
        color: #FBBF24;
        opacity: 0.6;
      }
      .stars-text {
        position: absolute;
        bottom: 0px;
        left: 0px;
        color: #FBBF24;
        font-size: 10px;
        font-weight: bold;
        background: rgba(0, 0, 0, 0.7);
        padding: 1px 3px;
        border-radius: 3px;
      }
      .team-hero-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.4), transparent);
    color: white;
    padding: 4px 2px;
    font-size: 11px;
    text-align: center;
    height: 60px; /* Augmenter la hauteur */
    display: flex;
    align-items: flex-end; /* Pousse le texte vers le bas */
    justify-content: center;
}
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <header class="text-center mb-8">
        <h1 class="text-2xl font-bold mb-2">KingsRaid Team Builder</h1>
      </header>

      <!-- Team Slots -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-center mb-4">Your Team</h2>
        
        <!-- Tous les slots disponibles imm√©diatement -->
        <div class="flex justify-center gap-6 flex-wrap" id="team-slots">
          <!-- 8 emplacements au total -->
        </div>

        <!-- Compteur d'√©quipe -->
        <div class="text-center text-sm text-gray-400 mt-4">
          Heroes: <span id="current-team-size">0</span>/<span id="max-team-size">8</span>
        </div>
      </div>

      <!-- Available Heroes -->
      <div>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Available Heroes</h2>
          <div class="flex gap-2">
            <select
              id="sort-filter"
              onchange="loadHeroes(this.value)"
              class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm"
            >
              <option value="name">Sort by Name</option>
              <option value="release">Sort by Release</option>
            </select>

            <select
              id="role-filter"
              class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm"
            >
              <option value="all">All Roles</option>
              <option value="Knight">Knight</option>
              <option value="Warrior">Warrior</option>
              <option value="Archer">Archer</option>
              <option value="Mechanic">Mechanic</option>
              <option value="Assassin">Assassin</option>
              <option value="Wizard">Wizard</option>
              <option value="Priest">Priest</option>
            </select>
            <input
              type="text"
              id="search-input"
              placeholder="Search..."
              class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm w-32"
            />
          </div>
        </div>

        <div
          id="heroes-grid"
          class="grid grid-cols-8 md:grid-cols-12 lg:grid-cols-16 xl:grid-cols-20 gap-1"
        >
          <!-- Heroes will be loaded here -->
        </div>
        <div
          id="hero-count"
          class="text-center text-gray-400 text-sm mt-4"
        ></div>
      </div>
    </div>

    <!-- Modal pour choisir les images UW -->
    <div id="uw-modal" class="modal">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-4 text-center">UW</h3>
        <div class="flex justify-center gap-4 mb-4" id="uw-options">
          <!-- Les options UW seront ajout√©es ici dynamiquement -->
        </div>
        <div class="stars-container" id="uw-stars">
          <!-- Les √©toiles UW seront ajout√©es ici dynamiquement -->
        </div>
        <div class="flex justify-center gap-4 mt-6">
          <button id="confirm-uw" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Confirm</button>
          <button id="cancel-uw" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Modal pour choisir les images UT -->
    <div id="ut-modal" class="modal">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-4 text-center">UT</h3>
        <div class="grid grid-cols-2 gap-4 justify-items-center mb-4" id="ut-options">
          <!-- Les options UT seront ajout√©es ici dynamiquement -->
        </div>
        <div class="flex justify-center mb-4" id="ut-empty-option">
          <!-- L'option vide pour UT sera ajout√©e ici dynamiquement -->
        </div>
        <div class="stars-container" id="ut-stars">
          <!-- Les √©toiles UT seront ajout√©es ici dynamiquement -->
        </div>
        <div class="flex justify-center gap-4 mt-6">
          <button id="confirm-ut" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Confirm</button>
          <button id="cancel-ut" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Modal pour choisir les artefacts -->
    <div id="artifact-modal" class="modal">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-4 text-center">Artifact</h3>
        <div class="grid grid-cols-3 gap-4 justify-items-center mb-4" id="artifact-options">
          <!-- Les options artefacts seront ajout√©es ici dynamiquement -->
        </div>
        <div class="flex justify-center mb-4" id="artifact-empty-option">
          <!-- L'option vide pour artefact sera ajout√©e ici dynamiquement -->
        </div>
        <div class="stars-container" id="artifact-stars">
          <!-- Les √©toiles artefact seront ajout√©es ici dynamiquement -->
        </div>
        <div class="flex justify-center gap-4 mt-6">
          <button id="confirm-artifact" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Confirm</button>
          <button id="cancel-artifact" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      // CONFIGURATION SIMPLIFIEE
      const MAX_TEAM_SLOTS = 8;
      
      let currentTeam = Array(MAX_TEAM_SLOTS).fill(null);
      let allHeroes = [];
      let allArtifacts = [];
      let currentSubSlots = Array(MAX_TEAM_SLOTS).fill(null).map(() => Array(4).fill(null));
      let currentSubStars = Array(MAX_TEAM_SLOTS).fill(null).map(() => Array(4).fill(0));
      let currentModalData = null;

      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ DOM charg√© - Initialisation...");
        initializeTeamSlots();
        setupFilters();
        setupModals();
        loadHeroes();
        loadArtifacts();
      });

      async function loadArtifacts() {
        try {
          console.log(`üîÑ Chargement des artefacts...`);
          const response = await fetch('/kingsraid-data/artifact_release_order.json');

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("üìä Donn√©es artefacts re√ßues:", data);

          allArtifacts = data.artifacts || [];
          console.log(`‚úÖ ${allArtifacts.length} artefacts charg√©s`);
        } catch (error) {
          console.error("‚ùå Error loading artifacts:", error);
          allArtifacts = [];
        }
      }

      function initializeTeamSlots() {
        const teamSlots = document.getElementById("team-slots");
        teamSlots.innerHTML = "";

        // Cr√©er tous les slots avec sous-slots
        for (let i = 0; i < MAX_TEAM_SLOTS; i++) {
          const slotContainer = document.createElement("div");
          slotContainer.className = "flex flex-col items-center gap-2";
          
          // Slot principal (H√©ro)
          const mainSlot = document.createElement("div");
          mainSlot.className = "character-slot w-[100px] h-[100px] rounded flex items-center justify-center cursor-pointer empty";
          mainSlot.innerHTML = '<span class="text-gray-400 text-lg">+</span>';
          
          // Container pour les 4 sous-slots (2x2)
          const subSlotsContainer = document.createElement("div");
          subSlotsContainer.className = "grid grid-cols-2 gap-1";
          
          // Cr√©er 4 sous-slots / sub-slot : UW, Ut, Artifacts, Perks
          for (let j = 0; j < 4; j++) {
            const subSlot = document.createElement("div");
            subSlot.className = "sub-slot w-[48px] h-[48px] rounded flex items-center justify-center cursor-pointer empty";
            subSlot.innerHTML = '<span class="text-gray-400 text-xs">+</span>';
            subSlot.onclick = () => handleSubSlotClick(i, j);
            subSlotsContainer.appendChild(subSlot);
          }
          
          slotContainer.appendChild(mainSlot);
          slotContainer.appendChild(subSlotsContainer);
          teamSlots.appendChild(slotContainer);
        }

        updateTeamDisplay();
      }

      function setupModals() {
        // Modal UW
        const uwModal = document.getElementById('uw-modal');
        const confirmUwBtn = document.getElementById('confirm-uw');
        const cancelUwBtn = document.getElementById('cancel-uw');

        confirmUwBtn.addEventListener('click', confirmUWSelection);
        cancelUwBtn.addEventListener('click', () => closeModal('uw-modal'));

        uwModal.addEventListener('click', (e) => {
          if (e.target === uwModal) {
            closeModal('uw-modal');
          }
        });

        // Modal UT
        const utModal = document.getElementById('ut-modal');
        const confirmUtBtn = document.getElementById('confirm-ut');
        const cancelUtBtn = document.getElementById('cancel-ut');

        confirmUtBtn.addEventListener('click', confirmUTSelection);
        cancelUtBtn.addEventListener('click', () => closeModal('ut-modal'));

        utModal.addEventListener('click', (e) => {
          if (e.target === utModal) {
            closeModal('ut-modal');
          }
        });

        // Modal Artifact
        const artifactModal = document.getElementById('artifact-modal');
        const confirmArtifactBtn = document.getElementById('confirm-artifact');
        const cancelArtifactBtn = document.getElementById('cancel-artifact');

        confirmArtifactBtn.addEventListener('click', confirmArtifactSelection);
        cancelArtifactBtn.addEventListener('click', () => closeModal('artifact-modal'));

        artifactModal.addEventListener('click', (e) => {
          if (e.target === artifactModal) {
            closeModal('artifact-modal');
          }
        });
      }

      function handleSubSlotClick(teamSlotIndex, subSlotIndex) {
        const hero = currentTeam[teamSlotIndex];
        if (!hero) {
          alert('Veuillez d\'abord ajouter un h√©ros dans ce slot!');
          return;
        }

        // Slot 0: UW (uw.png)
        if (subSlotIndex === 0) {
          openUWModal(teamSlotIndex, subSlotIndex, hero.name);
        }
        // Slot 1: UT (choix parmi 1.png, 2.png, 3.png, 4.png)
        else if (subSlotIndex === 1) {
          openUTModal(teamSlotIndex, subSlotIndex, hero.name);
        }
        // Slot 2: Artifact
        else if (subSlotIndex === 2) {
          openArtifactModal(teamSlotIndex, subSlotIndex);
        }
        // Slot 3: R√©serv√© pour future fonctionnalit√©
        else if (subSlotIndex === 3) {
          alert('Slot r√©serv√© pour une future fonctionnalit√©!');
        }
      }

      function openUWModal(teamSlotIndex, subSlotIndex, heroName) {
        currentModalData = { 
          teamSlotIndex, 
          subSlotIndex, 
          heroName,
          selectedStars: currentSubStars[teamSlotIndex][subSlotIndex] || 0,
          selectedOption: currentSubSlots[teamSlotIndex][subSlotIndex] ? 'uw' : 'empty'
        };
        
        const modal = document.getElementById('uw-modal');
        const optionsContainer = document.getElementById('uw-options');
        const starsContainer = document.getElementById('uw-stars');
        
        // Cr√©er les options UW
        optionsContainer.innerHTML = '';
        
        // Option UW
        const uwOption = document.createElement('div');
        uwOption.className = `uw-option ${currentModalData.selectedOption === 'uw' ? 'selected' : ''}`;
        const uwPath = `/kingsraid-data/assets/heroes/${heroName}/uw.png`;
        uwOption.innerHTML = `<img src="${uwPath}" alt="UW" class="w-full h-full object-cover rounded">`;
        uwOption.onclick = () => selectUWOption('uw');
        optionsContainer.appendChild(uwOption);

        // Option vide
        const emptyOption = document.createElement('div');
        emptyOption.className = `uw-option ${currentModalData.selectedOption === 'empty' ? 'selected' : ''}`;
        emptyOption.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-400 text-sm">Empty</div>';
        emptyOption.onclick = () => selectUWOption('empty');
        optionsContainer.appendChild(emptyOption);

        // Cr√©er les √©toiles
        createStars(starsContainer, 'uw', currentModalData.selectedStars);
        
        modal.style.display = 'flex';
      }

      function openUTModal(teamSlotIndex, subSlotIndex, heroName) {
        currentModalData = { 
          teamSlotIndex, 
          subSlotIndex, 
          heroName,
          selectedUT: currentSubSlots[teamSlotIndex][subSlotIndex] ? 
            parseInt(currentSubSlots[teamSlotIndex][subSlotIndex].split('/ut/')[1].split('.')[0]) : 0,
          selectedStars: currentSubStars[teamSlotIndex][subSlotIndex] || 0
        };
        
        const modal = document.getElementById('ut-modal');
        const optionsContainer = document.getElementById('ut-options');
        const emptyContainer = document.getElementById('ut-empty-option');
        const starsContainer = document.getElementById('ut-stars');
        
        optionsContainer.innerHTML = '';
        emptyContainer.innerHTML = '';
        
        // Cr√©er les 4 options UT
        for (let i = 1; i <= 4; i++) {
          const option = document.createElement('div');
          option.className = `ut-option ${currentModalData.selectedUT === i ? 'selected' : ''}`;
          const utPath = `/kingsraid-data/assets/heroes/${heroName}/ut/${i}.png`;
          option.innerHTML = `<img src="${utPath}" alt="UT ${i}" class="w-full h-full object-cover rounded">`;
          option.onclick = () => selectUTOption(i);
          optionsContainer.appendChild(option);
        }

        // Option vide (en dessous)
        const emptyOption = document.createElement('div');
        emptyOption.className = `ut-option ${currentModalData.selectedUT === 0 ? 'selected' : ''}`;
        emptyOption.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-400 text-sm">Empty</div>';
        emptyOption.onclick = () => selectUTOption(0);
        emptyContainer.appendChild(emptyOption);

        // Cr√©er les √©toiles
        createStars(starsContainer, 'ut', currentModalData.selectedStars);
        
        modal.style.display = 'flex';
      }

      function openArtifactModal(teamSlotIndex, subSlotIndex) {
        currentModalData = { 
          teamSlotIndex, 
          subSlotIndex,
          selectedArtifact: currentSubSlots[teamSlotIndex][subSlotIndex] ? 
            currentSubSlots[teamSlotIndex][subSlotIndex].split('/artifacts/')[1].split('.')[0] : null,
          selectedStars: currentSubStars[teamSlotIndex][subSlotIndex] || 0
        };
        
        const modal = document.getElementById('artifact-modal');
        const optionsContainer = document.getElementById('artifact-options');
        const emptyContainer = document.getElementById('artifact-empty-option');
        const starsContainer = document.getElementById('artifact-stars');
        
        optionsContainer.innerHTML = '';
        emptyContainer.innerHTML = '';
        
        // Cr√©er les options artefacts
        allArtifacts.forEach((artifactName, index) => {
          const option = document.createElement('div');
          option.className = `artifact-option ${currentModalData.selectedArtifact === artifactName ? 'selected' : ''}`;
          const artifactPath = `/kingsraid-data/assets/artifacts/${artifactName}.png`;
          option.innerHTML = `<img src="${artifactPath}" alt="${artifactName}" class="w-full h-full object-cover rounded">`;
          option.onclick = () => selectArtifactOption(artifactName);
          optionsContainer.appendChild(option);
        });

        // Option vide (en dessous)
        const emptyOption = document.createElement('div');
        emptyOption.className = `artifact-option ${currentModalData.selectedArtifact === null ? 'selected' : ''}`;
        emptyOption.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-400 text-sm">Empty</div>';
        emptyOption.onclick = () => selectArtifactOption(null);
        emptyContainer.appendChild(emptyOption);

        // Cr√©er les √©toiles
        createStars(starsContainer, 'artifact', currentModalData.selectedStars);
        
        modal.style.display = 'flex';
      }

      function selectUWOption(option) {
        // Retirer la s√©lection pr√©c√©dente
        document.querySelectorAll('.uw-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Ajouter la s√©lection actuelle
        event.target.closest('.uw-option').classList.add('selected');
        
        // Stocker temporairement l'option s√©lectionn√©e
        currentModalData.selectedOption = option;
      }

      function selectUTOption(utNumber) {
        // Retirer la s√©lection pr√©c√©dente
        document.querySelectorAll('.ut-option').forEach(option => {
          option.classList.remove('selected');
        });
        
        // Ajouter la s√©lection actuelle
        event.target.closest('.ut-option').classList.add('selected');
        
        // Stocker temporairement le num√©ro UT s√©lectionn√© (0 pour vide)
        currentModalData.selectedUT = utNumber;
      }

      function selectArtifactOption(artifactName) {
        // Retirer la s√©lection pr√©c√©dente
        document.querySelectorAll('.artifact-option').forEach(option => {
          option.classList.remove('selected');
        });
        
        // Ajouter la s√©lection actuelle
        event.target.closest('.artifact-option').classList.add('selected');
        
        // Stocker temporairement le nom de l'artefact s√©lectionn√© (null pour vide)
        currentModalData.selectedArtifact = artifactName;
      }

      function createStars(container, type, currentStars) {
        container.innerHTML = '';
        
        // Ajouter l'option 0 √©toiles (X) √† gauche
        const zeroStar = document.createElement('span');
        zeroStar.className = 'star';
        zeroStar.innerHTML = '√ó';
        zeroStar.style.color = '#EF4444';
        zeroStar.onclick = () => selectStars(0, type);
        container.appendChild(zeroStar);

        // Ajouter les 5 √©toiles
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.className = `star ${i <= currentStars ? 'filled' : ''}`;
          star.innerHTML = i <= currentStars ? '‚òÖ' : '‚òÜ';
          star.dataset.value = i;
          
          // √âv√©nements pour le hover preview (invers√©)
          star.addEventListener('mouseover', () => showHoverPreview(i, type, currentStars));
          star.addEventListener('mouseout', () => clearHoverPreview(type, currentStars));
          star.addEventListener('click', () => selectStars(i, type));
          
          container.appendChild(star);
        }
      }

      function showHoverPreview(hoveredStar, type, currentStars) {
        const starsContainer = document.getElementById(`${type}-stars`);
        const stars = starsContainer.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
          if (index > 0) { // Ignorer le √ó (index 0)
            const starValue = parseInt(star.dataset.value);
            if (starValue > currentStars && starValue <= hoveredStar) {
              // Les √©toiles au-dessus du niveau actuel et sous la souris deviennent semi-transparentes
              star.classList.add('hover-preview');
            } else {
              star.classList.remove('hover-preview');
            }
          }
        });
      }

      function clearHoverPreview(type, currentStars) {
        const starsContainer = document.getElementById(`${type}-stars`);
        const stars = starsContainer.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
          if (index > 0) {
            star.classList.remove('hover-preview');
          }
        });
      }

      function selectStars(starCount, type) {
        currentModalData.selectedStars = starCount;
        
        const starsContainer = document.getElementById(`${type}-stars`);
        const stars = starsContainer.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
          if (index > 0) { // Ignorer le √ó (index 0)
            if (index <= starCount) {
              star.innerHTML = '‚òÖ';
              star.classList.add('filled');
              star.classList.remove('hover-preview');
            } else {
              star.innerHTML = '‚òÜ';
              star.classList.remove('filled', 'hover-preview');
            }
          }
        });
      }

      function confirmUWSelection() {
        if (!currentModalData) {
          return;
        }

        const { teamSlotIndex, subSlotIndex, heroName, selectedOption, selectedStars } = currentModalData;
        
        if (selectedOption === 'empty') {
          // Option vide s√©lectionn√©e
          currentSubSlots[teamSlotIndex][subSlotIndex] = null;
          currentSubStars[teamSlotIndex][subSlotIndex] = 0;
          removeSubItem(teamSlotIndex, subSlotIndex);
        } else {
          // Option UW s√©lectionn√©e
          const uwPath = `/kingsraid-data/assets/heroes/${heroName}/uw.png`;
          currentSubSlots[teamSlotIndex][subSlotIndex] = uwPath;
          currentSubStars[teamSlotIndex][subSlotIndex] = selectedStars;
          updateSubSlotDisplay(teamSlotIndex, subSlotIndex, uwPath, selectedStars);
        }
        
        closeModal('uw-modal');
      }

      function confirmUTSelection() {
        if (!currentModalData || currentModalData.selectedUT === null) {
          alert('Veuillez s√©lectionner une option UT!');
          return;
        }

        const { teamSlotIndex, subSlotIndex, heroName, selectedUT, selectedStars } = currentModalData;
        
        if (selectedUT === 0) {
          // Option vide s√©lectionn√©e
          currentSubSlots[teamSlotIndex][subSlotIndex] = null;
          currentSubStars[teamSlotIndex][subSlotIndex] = 0;
          removeSubItem(teamSlotIndex, subSlotIndex);
        } else {
          // Option UT s√©lectionn√©e
          const utPath = `/kingsraid-data/assets/heroes/${heroName}/ut/${selectedUT}.png`;
          currentSubSlots[teamSlotIndex][subSlotIndex] = utPath;
          currentSubStars[teamSlotIndex][subSlotIndex] = selectedStars;
          updateSubSlotDisplay(teamSlotIndex, subSlotIndex, utPath, selectedStars);
        }
        
        closeModal('ut-modal');
      }

      function confirmArtifactSelection() {
        if (!currentModalData || currentModalData.selectedArtifact === undefined) {
          alert('Veuillez s√©lectionner une option Artifact!');
          return;
        }

        const { teamSlotIndex, subSlotIndex, selectedArtifact, selectedStars } = currentModalData;
        
        if (selectedArtifact === null) {
          // Option vide s√©lectionn√©e
          currentSubSlots[teamSlotIndex][subSlotIndex] = null;
          currentSubStars[teamSlotIndex][subSlotIndex] = 0;
          removeSubItem(teamSlotIndex, subSlotIndex);
        } else {
          // Option Artifact s√©lectionn√©e
          const artifactPath = `/kingsraid-data/assets/artifacts/${selectedArtifact}.png`;
          currentSubSlots[teamSlotIndex][subSlotIndex] = artifactPath;
          currentSubStars[teamSlotIndex][subSlotIndex] = selectedStars;
          updateSubSlotDisplay(teamSlotIndex, subSlotIndex, artifactPath, selectedStars);
        }
        
        closeModal('artifact-modal');
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
        currentModalData = null;
      }

      function updateSubSlotDisplay(teamSlotIndex, subSlotIndex, imagePath, stars) {
        const slotContainers = document.getElementById("team-slots").children;
        const slotContainer = slotContainers[teamSlotIndex];
        const subSlotsContainer = slotContainer.children[1];
        const subSlot = subSlotsContainer.children[subSlotIndex];
        
        const starsDisplay = stars > 0 ? 
          `<div class="stars-text">${stars}‚òÖ</div>` : 
          '';
        
        subSlot.className = "sub-slot w-[48px] h-[48px] rounded flex items-center justify-center cursor-pointer";
        subSlot.innerHTML = `
          <img src="${imagePath}" alt="Sub item" class="sub-slot-image">
          <div class="sub-remove-btn" onclick="removeSubItem(${teamSlotIndex}, ${subSlotIndex})">√ó</div>
          ${starsDisplay}
        `;
      }

      function removeSubItem(teamSlotIndex, subSlotIndex) {
        event.stopPropagation(); // Emp√™cher le d√©clenchement du click sur le sous-slot
        currentSubSlots[teamSlotIndex][subSlotIndex] = null;
        currentSubStars[teamSlotIndex][subSlotIndex] = 0;
        
        const slotContainers = document.getElementById("team-slots").children;
        const slotContainer = slotContainers[teamSlotIndex];
        const subSlotsContainer = slotContainer.children[1];
        const subSlot = subSlotsContainer.children[subSlotIndex];
        
        subSlot.className = "sub-slot w-[48px] h-[48px] rounded flex items-center justify-center cursor-pointer empty";
        subSlot.innerHTML = '<span class="text-gray-400 text-xs">+</span>';
      }

      // Modifiez loadHeroes pour accepter le tri
      async function loadHeroes(sortType = "name") {
        try {
          console.log(`üîÑ Chargement des h√©ros avec tri: ${sortType}`);
          const response = await fetch(`/api/heroes?sort=${sortType}`);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("üìä Donn√©es re√ßues:", data);

          allHeroes = data.heroes || [];
          currentSort = sortType;

          console.log(
            `‚úÖ ${allHeroes.length} h√©ros charg√©s avec tri: ${sortType}`
          );

          displayHeroes(allHeroes);
          updateHeroCount(allHeroes.length);

          document.getElementById("sort-filter").value = sortType;
        } catch (error) {
          console.error("‚ùå Error loading heroes:", error);
          allHeroes = [];
          displayHeroes([]);
          updateHeroCount(0);
        }
      }

      function displayHeroes(heroes) {
        const heroesGrid = document.getElementById("heroes-grid");

        if (!heroes || !Array.isArray(heroes)) {
          console.error("‚ùå displayHeroes: heroes n'est pas un array", heroes);
          heroes = [];
        }

        heroesGrid.innerHTML = "";

        console.log(`üé® Affichage de ${heroes.length} h√©ros`);

        heroes.forEach((hero) => {
          const heroCard = document.createElement("div");
          
          // V√©rifier si le h√©ros est dans l'√©quipe
          const isInTeam = currentTeam.some(slot => slot && slot.id === hero.id);
          
          heroCard.className = `hero-card rounded cursor-pointer ${isInTeam ? 'in-team' : ''}`;

          const classIconPath = getClassIconPath(hero.role);

          const classIconHTML = classIconPath
            ? `<img src="${classIconPath}" alt="${hero.role}" class="class-icon">`
            : "";

          heroCard.innerHTML = `
            <img src="${hero.image}" alt="${hero.name}" class="hero-image rounded">
            <div class="hero-name">${hero.name}</div>
            ${classIconHTML}
          `;

          // Comportement diff√©rent selon si le h√©ros est dans l'√©quipe ou non
          heroCard.onclick = () => {
            if (isInTeam) {
              removeHeroFromTeam(hero.id);
            } else {
              addHeroToTeam(hero);
            }
          };

          heroesGrid.appendChild(heroCard);
        });
      }

      function getClassIconPath(className) {
        const classMap = {
          Knight: "/kingsraid-data/assets/classes/knight.png",
          Warrior: "/kingsraid-data/assets/classes/warrior.png",
          Archer: "/kingsraid-data/assets/classes/archer.png",
          Mechanic: "/kingsraid-data/assets/classes/mechanic.png",
          Assassin: "/kingsraid-data/assets/classes/assassin.png",
          Wizard: "/kingsraid-data/assets/classes/wizard.png",
          Priest: "/kingsraid-data/assets/classes/priest.png",
        };

        return classMap[className] || null;
      }

      function setupFilters() {
        const roleFilter = document.getElementById("role-filter");
        const searchInput = document.getElementById("search-input");

        roleFilter.addEventListener("change", filterHeroes);
        searchInput.addEventListener("input", filterHeroes);

        console.log("‚úÖ Filtres r√¥le et recherche attach√©s");
      }

      function filterHeroes() {
        const roleFilter = document.getElementById("role-filter").value;
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();

        let filteredHeroes = allHeroes;

        if (roleFilter !== "all") {
          filteredHeroes = filteredHeroes.filter(
            (hero) => hero.role === roleFilter
          );
        }

        if (searchTerm) {
          filteredHeroes = filteredHeroes.filter((hero) =>
            hero.name.toLowerCase().includes(searchTerm)
          );
        }

        console.log(
          `üîç Filtrage: ${filteredHeroes.length} h√©ros apr√®s filtres`
        );
        displayHeroes(filteredHeroes);
        updateHeroCount(filteredHeroes.length);
      }

      function updateHeroCount(count) {
        document.getElementById("hero-count").textContent = `${count} heroes`;
      }

      function addHeroToTeam(hero) {
        const emptySlotIndex = currentTeam.findIndex((slot) => slot === null);
        if (emptySlotIndex !== -1) {
          // V√©rifier si le h√©ros est d√©j√† dans l'√©quipe
          if (currentTeam.some(slot => slot && slot.id === hero.id)) {
            alert('This hero is already in your team!');
            return;
          }
          
          currentTeam[emptySlotIndex] = hero;
          updateTeamDisplay();
          refreshHeroesDisplay(); // Met √† jour l'affichage des h√©ros
        } else {
          alert('No empty slots available! Remove a hero first.');
        }
      }

      function removeHeroFromTeam(heroId) {
        const heroIndex = currentTeam.findIndex(slot => slot && slot.id === heroId);
        if (heroIndex !== -1) {
          // Supprimer aussi les sous-slots associ√©s
          currentSubSlots[heroIndex] = Array(4).fill(null);
          currentSubStars[heroIndex] = Array(4).fill(0);
          currentTeam[heroIndex] = null;
          updateTeamDisplay();
          refreshHeroesDisplay(); // Met √† jour l'affichage des h√©ros
        }
      }

      function updateTeamDisplay() {
        const slotContainers = document.getElementById("team-slots").children;

        currentTeam.forEach((hero, index) => {
          const slotContainer = slotContainers[index];
          const mainSlot = slotContainer.children[0]; // Le slot principal
          const subSlotsContainer = slotContainer.children[1]; // Les sous-slots

          //====== Team slot size / taille ======
          if (hero) {
            const classIconPath = getClassIconPath(hero.role);
            const classIconHTML = classIconPath
              ? `<img src="${classIconPath}" alt="${hero.role}" class="class-icon">`
              : "";

            //taille de slot de basse
            mainSlot.className = "character-slot w-[100px] h-[100px] rounded flex items-center justify-center cursor-pointer";
            //taille de slot avec un hero
            mainSlot.innerHTML = `
              <img src="${hero.image}" alt="${hero.name}" class="w-full h-full rounded object-cover">
              <div class="team-hero-name">${hero.name}</div>
              ${classIconHTML}
              <div class="remove-btn" onclick="removeHeroFromTeam('${hero.id}')">√ó</div>
            `;

            // Mettre √† jour les sous-slots
            for (let j = 0; j < 4; j++) {
              const subSlot = subSlotsContainer.children[j];
              const subItem = currentSubSlots[index][j];
              const subStars = currentSubStars[index][j];
              
              if (subItem) {
                const starsDisplay = subStars > 0 ? 
                  `<div class="stars-text">${subStars}‚òÖ</div>` : 
                  '';
                
                subSlot.className = "sub-slot w-[48px] h-[48px] rounded flex items-center justify-center cursor-pointer";
                subSlot.innerHTML = `
                  <img src="${subItem}" alt="Sub item" class="sub-slot-image">
                  <div class="sub-remove-btn" onclick="removeSubItem(${index}, ${j})">√ó</div>
                  ${starsDisplay}
                `;
              } else {
                subSlot.className = "sub-slot w-[48px] h-[48px] rounded flex items-center justify-center cursor-pointer empty";
                subSlot.innerHTML = '<span class="text-gray-400 text-xs">+</span>';
              }
            }
          } else {
            //taille de slot vide
            mainSlot.className = "character-slot w-[100px] h-[100px] rounded flex items-center justify-center cursor-pointer empty";
            mainSlot.innerHTML = '<span class="text-gray-400 text-lg">+</span>';

            // R√©initialiser les sous-slots
            for (let j = 0; j < 4; j++) {
              const subSlot = subSlotsContainer.children[j];
              subSlot.className = "sub-slot w-[48px] h-[48px] rounded flex items-center justify-center cursor-pointer empty";
              subSlot.innerHTML = '<span class="text-gray-400 text-xs">+</span>';
            }
          }
        });

        // Mettre √† jour le compteur d'√©quipe
        const currentSize = currentTeam.filter(hero => hero !== null).length;
        document.getElementById('current-team-size').textContent = currentSize;
        document.getElementById('max-team-size').textContent = MAX_TEAM_SLOTS;
      }

      function refreshHeroesDisplay() {
        // R√©affiche les h√©ros avec les √©tats √† jour
        const roleFilter = document.getElementById("role-filter").value;
        const searchTerm = document.getElementById("search-input").value.toLowerCase();

        let filteredHeroes = allHeroes;

        if (roleFilter !== "all") {
          filteredHeroes = filteredHeroes.filter(
            (hero) => hero.role === roleFilter
          );
        }

        if (searchTerm) {
          filteredHeroes = filteredHeroes.filter((hero) =>
            hero.name.toLowerCase().includes(searchTerm)
          );
        }

        displayHeroes(filteredHeroes);
      }
    </script>
</body>
</html>