<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KingsRaid Team Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .character-slot {
        background: #374151;
        border: 2px dashed #6b7280;
      }
      .character-slot.empty:hover {
        background: #4b5563;
      }
      .hero-card {
        background: #1f2937;
        position: relative;
        aspect-ratio: 1;
      }
      .hero-name {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 2px;
        font-size: 11px;
        text-align: center;
      }
      .hero-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .class-icon {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 20px;
        height: 20px;
        background-color: black;
        border: 0.5px solid black;
        border-radius: 100%;
      }
      .class-icon.missing {
        display: none; /* Cache l'icÃ´ne si elle n'existe pas */
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <header class="text-center mb-8">
        <h1 class="text-2xl font-bold mb-2">KingsRaid Team Builder</h1>
      </header>

      <!-- Team Slots -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-center mb-4">Your Team</h2>
        <div class="flex justify-center gap-3" id="team-slots">
          <!-- 6 emplacements -->
        </div>
      </div>

      <!-- Available Heroes -->
      <div>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Available Heroes</h2>
          <div class="flex gap-2">
            <!-- SÃ©lecteur de tri avec onchange inline -->
            <select
              id="sort-filter"
              onchange="loadHeroes(this.value)"
              class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm"
            >
              <option value="name">Sort by Name</option>
              <option value="release">Sort by Release</option>
            </select>

            <select
              id="role-filter"
              class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm"
            >
              <option value="all">All Roles</option>
              <option value="Knight">Knight</option>
              <option value="Warrior">Warrior</option>
              <option value="Archer">Archer</option>
              <option value="Mechanic">Mechanic</option>
              <option value="Assassin">Assassin</option>
              <option value="Wizard">Wizard</option>
              <option value="Priest">Priest</option>
            </select>
            <input
              type="text"
              id="search-input"
              placeholder="Search..."
              class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm w-32"
            />
          </div>
        </div>

        <div
          id="heroes-grid"
          class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-2"
        >
          <!-- Heroes will be loaded here -->
        </div>
        <div
          id="hero-count"
          class="text-center text-gray-400 text-sm mt-4"
        ></div>
      </div>
    </div>

    <script>
      let currentTeam = Array(6).fill(null);
      let allHeroes = [];

      document.addEventListener("DOMContentLoaded", function () {
        console.log("ðŸš€ DOM chargÃ© - Initialisation...");
        initializeTeamSlots();
        setupFilters();
        loadHeroes();
      });

      function initializeTeamSlots() {
        const teamSlots = document.getElementById("team-slots");
        teamSlots.innerHTML = "";

        for (let i = 0; i < 6; i++) {
          const slot = document.createElement("div");
          slot.className =
            "character-slot w-16 h-16 rounded flex items-center justify-center cursor-pointer empty";
          slot.innerHTML = '<span class="text-gray-400">+</span>';
          slot.onclick = () => removeHero(i);
          teamSlots.appendChild(slot);
        }
      }

      // Modifiez loadHeroes pour accepter le tri
      async function loadHeroes(sortType = "name") {
        try {
          console.log(`ðŸ”„ Chargement des hÃ©ros avec tri: ${sortType}`);
          const response = await fetch(`/api/heroes?sort=${sortType}`);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("ðŸ“Š DonnÃ©es reÃ§ues:", data);

          // S'assurer que allHeroes est toujours un array
          allHeroes = data.heroes || [];
          currentSort = sortType;

          console.log(
            `âœ… ${allHeroes.length} hÃ©ros chargÃ©s avec tri: ${sortType}`
          );
          console.log(
            "ðŸ‘‘ Premiers hÃ©ros:",
            allHeroes.slice(0, 3).map((h) => h.name)
          );

          displayHeroes(allHeroes);
          updateHeroCount(allHeroes.length);

          // Mettre Ã  jour le sÃ©lecteur de tri
          document.getElementById("sort-filter").value = sortType;
        } catch (error) {
          console.error("âŒ Error loading heroes:", error);
          // RÃ©initialiser en cas d'erreur
          allHeroes = [];
          displayHeroes([]);
          updateHeroCount(0);
        }
      }

      function displayHeroes(heroes) {
        const heroesGrid = document.getElementById("heroes-grid");

        // S'assurer que heroes est toujours un array
        if (!heroes || !Array.isArray(heroes)) {
          console.error("âŒ displayHeroes: heroes n'est pas un array", heroes);
          heroes = [];
        }

        heroesGrid.innerHTML = "";

        console.log(`ðŸŽ¨ Affichage de ${heroes.length} hÃ©ros`);
        if (heroes.length > 0) {
          console.log(
            "ðŸ‘‘ Premiers hÃ©ros affichÃ©s:",
            heroes.slice(0, 3).map((h) => h.name)
          );
        }

        heroes.forEach((hero) => {
          const heroCard = document.createElement("div");
          heroCard.className = "hero-card rounded cursor-pointer";

          const classIconPath = getClassIconPath(hero.role);

          // Construction conditionnelle de l'icÃ´ne
          const classIconHTML = classIconPath
            ? `<img src="${classIconPath}" alt="${hero.role}" class="class-icon">`
            : "";

          heroCard.innerHTML = `
            <img src="${hero.image}" alt="${hero.name}" class="hero-image rounded">
            <div class="hero-name">${hero.name}</div>
            ${classIconHTML}
          `;

          heroCard.onclick = () => addHeroToTeam(hero);
          heroesGrid.appendChild(heroCard);
        });
      }

      function getClassIconPath(className) {
        const classMap = {
          Knight: "/kingsraid-data/assets/classes/knight.png",
          Warrior: "/kingsraid-data/assets/classes/warrior.png",
          Archer: "/kingsraid-data/assets/classes/archer.png",
          Mechanic: "/kingsraid-data/assets/classes/mechanic.png",
          Assassin: "/kingsraid-data/assets/classes/assassin.png",
          Wizard: "/kingsraid-data/assets/classes/wizard.png",
          Priest: "/kingsraid-data/assets/classes/priest.png",
        };

        // Retourne l'icÃ´ne si elle existe, sinon null pour ne pas afficher d'image
        return classMap[className] || null;
      }

      function setupFilters() {
        const roleFilter = document.getElementById("role-filter");
        const searchInput = document.getElementById("search-input");

        roleFilter.addEventListener("change", filterHeroes);
        searchInput.addEventListener("input", filterHeroes);

        console.log("âœ… Filtres rÃ´le et recherche attachÃ©s");
      }

      function filterHeroes() {
        const roleFilter = document.getElementById("role-filter").value;
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();

        let filteredHeroes = allHeroes;

        // Filtre par rÃ´le
        if (roleFilter !== "all") {
          filteredHeroes = filteredHeroes.filter(
            (hero) => hero.role === roleFilter
          );
        }

        // Filtre par recherche
        if (searchTerm) {
          filteredHeroes = filteredHeroes.filter((hero) =>
            hero.name.toLowerCase().includes(searchTerm)
          );
        }

        console.log(
          `ðŸ” Filtrage: ${filteredHeroes.length} hÃ©ros aprÃ¨s filtres`
        );
        displayHeroes(filteredHeroes);
        updateHeroCount(filteredHeroes.length);
      }

      function updateHeroCount(count) {
        document.getElementById("hero-count").textContent = `${count} heroes`;
      }

      function addHeroToTeam(hero) {
        const emptySlotIndex = currentTeam.findIndex((slot) => slot === null);
        if (emptySlotIndex !== -1) {
          currentTeam[emptySlotIndex] = hero;
          updateTeamSlots();
        }
      }

      function removeHero(index) {
        if (currentTeam[index]) {
          currentTeam[index] = null;
          updateTeamSlots();
        }
      }

      function updateTeamSlots() {
        const slots = document.getElementById("team-slots").children;

        currentTeam.forEach((hero, index) => {
          const slot = slots[index];
          if (hero) {
            slot.className =
              "character-slot w-16 h-16 rounded flex items-center justify-center cursor-pointer";
            slot.innerHTML = `<img src="${hero.image}" alt="${hero.name}" class="w-14 h-14 rounded object-cover">`;
          } else {
            slot.className =
              "character-slot w-16 h-16 rounded flex items-center justify-center cursor-pointer empty";
            slot.innerHTML = '<span class="text-gray-400">+</span>';
          }
        });
      }
    </script>
  </body>
</html>
